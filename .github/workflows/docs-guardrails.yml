name: Docs Guardrails

on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [main, dev]

concurrency:
  group: docs-guardrails-${{ github.ref }}
  cancel-in-progress: true

jobs:
  docs:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Link check + Mermaid sanity
        run: node ./scripts/docs/guardrails.mjs

      - name: Compute changed markdown files
        id: changed
        shell: bash
        run: |
          set -euo pipefail
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            BASE="${{ github.event.pull_request.base.sha }}"
            HEAD="${{ github.event.pull_request.head.sha }}"
          else
            BASE="$(git rev-parse HEAD~1)"
            HEAD="$(git rev-parse HEAD)"
          fi
          FILES="$(git diff --name-only "$BASE" "$HEAD" -- '*.md' | tr '\n' ' ')"
          echo "files=$FILES" >> "$GITHUB_OUTPUT"

      - name: Markdown lint (changed files only)
        if: steps.changed.outputs.files != ''
        run: npx --yes markdownlint-cli2 ${{ steps.changed.outputs.files }}

      - name: Spell check (changed files only)
        if: steps.changed.outputs.files != ''
        run: npx --yes cspell lint -c ./cspell.json ${{ steps.changed.outputs.files }}

